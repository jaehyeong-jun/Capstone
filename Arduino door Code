#include <Servo.h>

int sensor = 13;                 // 노크 센서에 연결된 13번 핀을 sensor 변수에 저장
int piezo = 12;                  // 피에조 부저에 연결된 12번 핀을 piezo 변수에 저장

Servo motor1;                    // 첫 번째 모터
Servo motor2;                    // 두 번째 모터

unsigned long previousMillis = 0;        // 부저 이전 시간 저장용 변수
const long interval = 1000;              // 부저 소리 발생 간격 (1초)
int beepCount = 0;                       // 소리 발생 횟수 추적
bool buzzing = false;                    // 부저 상태 추적

bool motorRunning = false;               // 모터 상태 추적
unsigned long motorStartMillis = 0;      // 모터 회전 시작 시간
unsigned long reverseStartMillis = 0;    // 반대 방향 회전 시작 시간
const long motorRotationTime = 10000;    // 모터가 120도 회전한 후 유지하는 시간 (500ms)
const long reverseDelay = 10000;         // 모터가 10초 뒤에 반대 방향으로 회전

bool reversing = false;                  // 반대 방향 회전 중인지 확인

void setup() {
  pinMode(piezo, OUTPUT);    // 피에조 부저를 출력으로 설정
  pinMode(sensor, INPUT);    // 노크 센서를 입력으로 설정
  
  motor1.attach(5);          // 첫 번째 모터 5번 핀에 연결
  motor2.attach(6);          // 두 번째 모터 6번 핀에 연결

  Serial.begin(9600);        // 시리얼 모니터 시작
}

void loop() {
  int data = digitalRead(sensor);  // 노크 센서의 입력값을 읽음

  unsigned long currentMillis = millis();  // 현재 시간 저장

  // 노크 센서 동작 (충격이 감지되었고, 모터가 작동 중이지 않으며 부저가 울리지 않을 때)
  if (data == LOW && !buzzing && !motorRunning && !reversing) {
    buzzing = true;                 // 부저 울림 시작
    beepCount = 0;                  // 소리 횟수 초기화
    previousMillis = currentMillis;  // 부저 시작 시간 저장
    tone(piezo, 262);               // 부저에서 첫 소리 발생

    // 두 개의 모터를 120도 회전시키기 시작
    motorRunning = true;
    motorStartMillis = currentMillis;  // 모터 회전 시작 시간 저장
    motor1.write(120);                // 첫 번째 모터 120도 회전
    motor2.write(120);                // 두 번째 모터 120도 회전
  }

  // 모터가 120도 회전 완료 시 멈춤
  if (motorRunning && (currentMillis - motorStartMillis >= motorRotationTime)) {
    motor1.write(0);            // 첫 번째 모터 0도로 회전 (멈춤)
    motor2.write(0);            // 두 번째 모터 0도로 회전 (멈춤)
    motorRunning = false;             // 모터 상태 초기화
    reverseStartMillis = currentMillis;  // 10초 후 반대 방향 회전 시작 시간 저장
  }

  // 부저가 울리는 동안 1초 간격으로 3번 소리 발생
  if (buzzing && (currentMillis - previousMillis >= interval)) {
    previousMillis = currentMillis;  // 이전 시간을 현재 시간으로 갱신
    beepCount++;                     // 소리 발생 횟수 증가

    if (beepCount <= 1) {
      tone(piezo, 262);  // 262Hz 소리 발생
    } else {
      noTone(piezo);     // 3번 소리가 나면 부저 끔
      buzzing = false;   // 부저 상태 초기화
    }
  }


}
